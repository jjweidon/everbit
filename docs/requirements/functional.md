# 기능 요구사항 (FRD)

## 2.1 목표

* 업비트 기반 자동매매 시스템 v2 구축
* 싱글 테넌트(1인) 기준으로 기능을 빠르게 안정화
* 문서/테스트/보안/관측 가능성을 기본 내장

## 2.2 사용자/권한 모델

* 사용자 역할: **OWNER 단일**
* 정책: **최초 카카오 로그인 계정이 OWNER로 고정**
* 이후 로그인 시 카카오 `id` 또는 email이 OWNER와 다르면 차단

### FR-AUTH-001 (P0) 카카오 OAuth2 로그인

* 설명: 카카오 OAuth2로만 인증한다.
* 수용 기준:

  * 로그인 성공 시 서버가 자체 JWT(Access/Refresh)를 발급한다.
  * Refresh는 HttpOnly 쿠키 또는 서버 저장 중 하나로 일관되게 적용한다(보안 요구사항에서 고정).
  * 최초 로그인은 USER 엔티티 생성 + OWNER로 지정.

### FR-AUTH-002 (P0) 1인 전용 계정 락

* 설명: OWNER 계정 1개만 허용한다.
* 수용 기준:

  * OWNER가 이미 존재하면, 다른 카카오 계정 로그인은 403 처리 + 사유 로그 남김.

---

## 2.3 업비트 API 키 관리

업비트 주문/자산 API는 레이트 리밋이 **초 단위**로 적용되고, 그룹별 제한이 있으므로 호출 제어가 필수입니다. ([업비트 개발자 센터](https://docs.upbit.com/kr/reference/rate-limits))

### FR-UPBIT-KEY-001 (P0) API 키 등록

* 입력: accessKey, secretKey
* 수용 기준:

  * 등록 즉시 "검증 API 호출" 수행
  * 성공 시 DB에 암호화 저장
  * 실패 시 저장하지 않음

### FR-UPBIT-KEY-002 (P0) API 키 검증

* 설명: 업비트 자산 조회 등 "읽기 1회"로 키 유효성 검증
* 수용 기준:

  * 레이트리밋 위반 시(429) 즉시 백오프/재시도 정책 적용
  * 검증 결과를 UI에서 확인 가능(성공/실패/시간)

### FR-UPBIT-KEY-003 (P0) API 키 폐기

* 수용 기준:

  * DB에서 키 삭제(또는 암호문 폐기) 후 즉시 매매 기능 비활성화
  * 모든 트레이딩 잡/컨슈머가 "키 없음" 상태를 감지하고 정지

---

## 2.4 전략/매매 실행

전략 상세는 별도 문서(EXTREME_FLIP/spec.md)에서 정의하고, 여기서는 **전략 실행 프레임**만 고정합니다.

### FR-TRADE-001 (P0) 전략 단위 실행(전략 1개 + 여러 마켓)

* 설명: EXTREME_FLIP 1개 전략을 여러 마켓(KRW-*)에 대해 동시에 실행한다.
* 수용 기준:

  * "활성 마켓 리스트"를 설정할 수 있다(예: KRW-BTC, KRW-ETH…)
  * 마켓별 상태(포지션/평균단가/보유수량/최근 신호)가 분리 관리된다.

### FR-TRADE-002 (P0) 주문 금액 최소/최대 설정

* 설명: KRW 기준으로 매수/매도 각각 최소·최대 주문 금액을 설정한다.
* 수용 기준:

  * "매도=매수 동일 적용" / "매수=매도 동일 적용" UI 버튼 제공
  * 주문 생성 직전 리스크 필터에서 강제 적용

### FR-TRADE-003 (P0) 리스크 규칙(손절/익절/트레일링)

* 설명: MVP에 포함한다(세부 파라미터는 전략 설정에서 관리).
* 수용 기준:

  * 손절/익절/트레일링이 주문 실행 파이프라인에서 **강제 게이트**로 동작
  * 이벤트/로그로 "왜 주문이 차단/실행됐는지" 남는다

### FR-TRADE-004 (P0) Kill Switch

* **계정 단위 Kill Switch**

  * UI: 웹 헤더에 ON/OFF
  * 동작: OFF 시 신규 주문 생성/전송 금지, 실행 루프 중단
* **전략 단위 Kill Switch**

  * 동작: "설정된 전략으로만 매매 실행" (즉, 허용 전략 리스트 외 차단)

---

## 2.5 주문 멱등성/추적(핵심)

업비트는 주문 생성 시 클라이언트 지정 식별자 `identifier`를 지원하며(주문 조회에도 사용), **멱등 처리의 키로 쓰는 게 유리**합니다. ([업비트 개발자 센터](https://docs.upbit.com/kr/reference/get-order))

### FR-ORDER-001 (P0) 주문 식별자(identifier) 기반 멱등 처리

* 설명: 동일 조건에서 중복 주문이 나가지 않도록 "클라이언트 주문 ID"를 표준화한다.
* 수용 기준:

  * 모든 주문 요청에 `identifier = {strategyKey}:{market}:{timeframe}:{signalId}` 규칙 적용
  * 재시도/재기동 시 같은 signalId면 같은 identifier로 주문을 재전송하거나 조회로 대체
  * 주문 조회 API로 uuid 또는 identifier 기반 추적 가능

---

## 2.6 백테스트

### FR-BT-001 (P0) 멀티 마켓/멀티 타임프레임 백테스트 실행

* 입력: 마켓 리스트, 타임프레임 리스트, 기간, 초기 자본
* 출력(최소 산출물): CAGR, MDD, 승률, 수익 팩터
* 수용 기준:

  * 결과를 DB에 저장하고 조회 가능
  * 동일 설정 재실행 시 "실행 이력"으로 버전 관리(전략 버전 포함)

### FR-BT-002 (P0) 지표 정의

* CAGR/MDD/승률/수익 팩터 산식은 `docs/testing/performance-plan.md` 또는 `docs/requirements/functional.md`에 고정(변경 시 ADR 필수)

---

## 2.7 대시보드

### FR-UI-001 (P0) 트레이딩 실행 상태

* 전략 실행 ON/OFF, 마켓별 상태, 마지막 실행 시각, 에러 상태 표시

### FR-UI-002 (P0) 최근 주문/잔고/손익

* 최근 주문 리스트(상태/체결/시간)
* 현재 잔고(현금+보유자산)
* 손익(실현/미실현 최소 구분)
